<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - PuyDeCom Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="icon" href="https://puydecom.fr/images/Logo-Puy-De-Com.jpeg">
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex">
                    <div class="flex-shrink-0 flex items-center">
                        <a href="./dashboard.html" class="text-xl font-bold text-indigo-600">
                            PuyDeCom Admin
                        </a>
                        <span class="ml-2 text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">
                            Supabase
                        </span>
                    </div>
                    <!-- Menu desktop -->
                    <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
                        <a href="./dashboard.html" class="border-indigo-500 text-indigo-600 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            <span class="mr-2">üìä</span>
                            Dashboard
                        </a>
                        <a href="./clients.html" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            <span class="mr-2">üë•</span>
                            Clients
                        </a>
                        <a href="./projets.html" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            <span class="mr-2">üìÅ</span>
                            Projets
                        </a>
                        <a href="./leads.html" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            <span class="mr-2">üéØ</span>
                            Leads
                        </a>
                        <a href="https://mail.hostinger.com/" target="_blank" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            <span class="mr-2">üìß</span>
                            Emails
                        </a>
                    </div>
                </div>
                <div class="flex items-center">
                    <!-- Bouton menu mobile -->
                    <div class="-mr-2 flex items-center sm:hidden">
                        <button id="mobile-menu-button" type="button" class="bg-white inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500">
                            <span class="sr-only">Ouvrir le menu</span>
                            <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <div id="userEmail" class="text-sm text-gray-600"></div>
                    <a href="/" target="_blank" class="text-gray-500 hover:text-gray-700 px-3 py-2 text-sm font-medium">
                        Voir le site
                    </a>
                    <button
                        id="logoutButton"
                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
                    >
                        D√©connexion
                    </button>
                </div>
            </div>
        </div>

        <!-- Menu mobile -->
        <div id="mobile-menu" class="sm:hidden hidden">
            <div class="pt-2 pb-3 space-y-1">
                <a href="./dashboard.html" class="bg-indigo-50 border-indigo-500 text-indigo-700 block pl-3 pr-4 py-2 border-l-4 text-base font-medium">
                    üìä Dashboard
                </a>
                <a href="./clients.html" class="border-transparent text-gray-500 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-700 block pl-3 pr-4 py-2 border-l-4 text-base font-medium">
                    üë• Clients
                </a>
                <a href="./projets.html" class="border-transparent text-gray-500 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-700 block pl-3 pr-4 py-2 border-l-4 text-base font-medium">
                    üìÅ Projets
                </a>
                <a href="./leads.html" class="border-transparent text-gray-500 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-700 block pl-3 pr-4 py-2 border-l-4 text-base font-medium">
                    üéØ Leads
                </a>
                <a href="https://mail.hostinger.com/" target="_blank" class="border-transparent text-gray-500 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-700 block pl-3 pr-4 py-2 border-l-4 text-base font-medium">
                    üìß Emails
                </a>
            </div>
        </div>
    </nav>

    <!-- Contenu principal -->
    <main class="py-6">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="space-y-6">
                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center space-y-4 sm:space-y-0">
                    <div>
                        <h1 class="text-xl sm:text-2xl font-bold text-gray-900">Dashboard</h1>
                        <p class="mt-1 sm:mt-2 text-sm sm:text-base text-gray-600">
                            Bienvenue dans votre espace d'administration PuyDeCom
                        </p>
                    </div>
                    <div class="flex flex-col sm:flex-row sm:items-center space-y-2 sm:space-y-0 sm:space-x-3">
                        <div id="lastUpdate" class="text-xs text-gray-500 text-center sm:text-left"></div>
                        <button id="refreshBtn" class="inline-flex items-center justify-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 min-h-[44px]">
                            <svg class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                            Actualiser
                        </button>
                    </div>
                </div>

                <!-- KPIs -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white overflow-hidden shadow rounded-lg">
                        <div class="p-5">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <span class="text-2xl">üë•</span>
                                </div>
                                <div class="ml-5 w-0 flex-1">
                                    <dl>
                                        <dt class="text-sm font-medium text-gray-500 truncate">
                                            Clients actifs
                                        </dt>
                                        <dd id="clientsActifs" class="text-lg font-medium text-gray-900">
                                            <div class="animate-pulse h-6 bg-gray-200 rounded"></div>
                                        </dd>
                                    </dl>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white overflow-hidden shadow rounded-lg">
                        <div class="p-5">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <span class="text-2xl">üìÅ</span>
                                </div>
                                <div class="ml-5 w-0 flex-1">
                                    <dl>
                                        <dt class="text-sm font-medium text-gray-500 truncate">
                                            Projets en cours
                                        </dt>
                                        <dd id="projetsEnCours" class="text-lg font-medium text-gray-900">
                                            <div class="animate-pulse h-6 bg-gray-200 rounded"></div>
                                        </dd>
                                    </dl>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white overflow-hidden shadow rounded-lg">
                        <div class="p-5">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <span class="text-2xl">üéØ</span>
                                </div>
                                <div class="ml-5 w-0 flex-1">
                                    <dl>
                                        <dt class="text-sm font-medium text-gray-500 truncate">
                                            Leads ce mois
                                        </dt>
                                        <dd id="leadsCeMois" class="text-lg font-medium text-gray-900">
                                            <div class="animate-pulse h-6 bg-gray-200 rounded"></div>
                                        </dd>
                                    </dl>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white overflow-hidden shadow rounded-lg">
                        <div class="p-5">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <span class="text-2xl">üí∞</span>
                                </div>
                                <div class="ml-5 w-0 flex-1">
                                    <dl>
                                        <dt class="text-sm font-medium text-gray-500 truncate">
                                            CA du mois
                                        </dt>
                                        <dd id="caDuMois" class="text-lg font-medium text-gray-900">
                                            <div class="animate-pulse h-6 bg-gray-200 rounded"></div>
                                        </dd>
                                    </dl>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Activit√©s et T√¢ches -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white shadow rounded-lg">
                        <div class="px-4 py-5 sm:p-6">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">
                                Derni√®res activit√©s
                            </h3>
                            <div class="mt-5">
                                <div id="activitesList" class="flow-root">
                                    <div class="animate-pulse space-y-4">
                                        <div class="h-4 bg-gray-200 rounded"></div>
                                        <div class="h-4 bg-gray-200 rounded"></div>
                                        <div class="h-4 bg-gray-200 rounded"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white shadow rounded-lg">
                        <div class="px-4 py-5 sm:p-6">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">
                                T√¢ches urgentes
                            </h3>
                            <div class="mt-5">
                                <div id="tachesList" class="flow-root">
                                    <div class="animate-pulse space-y-4">
                                        <div class="h-4 bg-gray-200 rounded"></div>
                                        <div class="h-4 bg-gray-200 rounded"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Message d'information -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <span class="text-blue-400 text-lg">‚ÑπÔ∏è</span>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-blue-800">
                                Zone admin statique avec Supabase
                            </h3>
                            <div class="mt-2 text-sm text-blue-700">
                                <p>Cette version utilise du HTML/CSS/JS vanilla avec Supabase et est enti√®rement compatible avec l'h√©bergement Hostinger statique !</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Configuration Supabase
        const SUPABASE_URL = 'https://ltqkbtfdjvslqktjtbod.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx0cWtidGZkanZzbHFrdGp0Ym9kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MjE1NzgsImV4cCI6MjA3MjM5NzU3OH0.RnZQZ3QmYrcedLK-IefXCQhTeNFJOUNmU7O0f5HGkLg';
        
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // V√©rifier l'authentification
        async function checkAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                window.location.href = './index.html';
                return false;
            }
            
            document.getElementById('userEmail').textContent = session.user.email;
            return true;
        }

        // D√©connexion
        document.getElementById('logoutButton').addEventListener('click', async () => {
            await supabaseClient.auth.signOut();
            window.location.href = './index.html';
        });

        // Gestion du menu mobile
        document.getElementById('mobile-menu-button').addEventListener('click', () => {
            const mobileMenu = document.getElementById('mobile-menu');
            mobileMenu.classList.toggle('hidden');
        });

        // Fonction pour afficher la derni√®re mise √† jour
        function updateLastRefreshTime() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = 
                `Derni√®re mise √† jour: ${now.toLocaleTimeString('fr-FR')}`;
        }

        // Fonction pour afficher les notifications
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-4 py-2 rounded-md text-white z-50 ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            }`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Charger les donn√©es du dashboard
        async function loadDashboardData(showSuccessNotification = false) {
            // Ajouter un indicateur de loading
            const refreshBtn = document.getElementById('refreshBtn');
            const originalText = refreshBtn.innerHTML;
            refreshBtn.innerHTML = `
                <svg class="animate-spin h-4 w-4 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Actualisation...
            `;
            refreshBtn.disabled = true;
            try {
                // Charger les clients actifs
                const { data: clients, error: clientsError } = await supabaseClient
                    .from('clients')
                    .select('*')
                    .eq('statut', 'actif');
                
                if (clientsError) throw clientsError;
                document.getElementById('clientsActifs').textContent = clients.length;

                // Charger les projets en cours
                const { data: projets, error: projetsError } = await supabaseClient
                    .from('projets')
                    .select('*')
                    .eq('statut', 'en_cours');
                
                if (projetsError) throw projetsError;
                document.getElementById('projetsEnCours').textContent = projets.length;

                // Charger les leads du mois
                const startOfMonth = new Date();
                startOfMonth.setDate(1);
                startOfMonth.setHours(0, 0, 0, 0);
                
                const { data: leads, error: leadsError } = await supabaseClient
                    .from('leads')
                    .select('*')
                    .gte('date_creation', startOfMonth.toISOString());
                
                if (leadsError) throw leadsError;
                document.getElementById('leadsCeMois').textContent = leads.length;

                // Charger le CA du mois (projets termin√©s)
                const { data: projetsTermines, error: caError } = await supabaseClient
                    .from('projets')
                    .select('budget')
                    .eq('statut', 'termine')
                    .gte('date_fin_reelle', startOfMonth.toISOString().split('T')[0]);
                
                if (caError) throw caError;
                const ca = projetsTermines.reduce((sum, p) => sum + (p.budget || 0), 0);
                document.getElementById('caDuMois').textContent = ca.toLocaleString('fr-FR') + '‚Ç¨';

                // Charger les derni√®res activit√©s
                const { data: activites, error: activitesError } = await supabaseClient
                    .from('activites')
                    .select('*')
                    .order('date_creation', { ascending: false })
                    .limit(5);
                
                if (activitesError) throw activitesError;
                
                const activitesList = document.getElementById('activitesList');
                if (activites.length > 0) {
                    activitesList.innerHTML = `
                        <ul class="-my-5 divide-y divide-gray-200">
                            ${activites.map(activite => `
                                <li class="py-4">
                                    <div class="flex items-center space-x-4">
                                        <div class="flex-1 min-w-0">
                                            <p class="text-sm font-medium text-gray-900 truncate">
                                                ${activite.titre}
                                            </p>
                                            <p class="text-sm text-gray-500">
                                                ${new Date(activite.date_creation).toLocaleString('fr-FR')}
                                            </p>
                                        </div>
                                    </div>
                                </li>
                            `).join('')}
                        </ul>
                    `;
                } else {
                    activitesList.innerHTML = '<p class="text-sm text-gray-500">Aucune activit√© r√©cente</p>';
                }

                // Charger les t√¢ches urgentes
                const { data: taches, error: tachesError } = await supabaseClient
                    .from('taches')
                    .select('*')
                    .in('statut', ['a_faire', 'en_cours'])
                    .order('date_echeance', { ascending: true })
                    .limit(5);
                
                if (tachesError) throw tachesError;
                
                const tachesList = document.getElementById('tachesList');
                if (taches.length > 0) {
                    tachesList.innerHTML = `
                        <ul class="-my-5 divide-y divide-gray-200">
                            ${taches.map(tache => `
                                <li class="py-4">
                                    <div class="flex items-center space-x-4">
                                        <div class="flex-1 min-w-0">
                                            <p class="text-sm font-medium text-gray-900 truncate">
                                                ${tache.titre}
                                            </p>
                                            <p class="text-sm ${tache.priorite === 'haute' ? 'text-red-600' : 'text-orange-600'}">
                                                ${tache.date_echeance ? '√âch√©ance : ' + new Date(tache.date_echeance).toLocaleDateString('fr-FR') : 'Pas d\'√©ch√©ance'}
                                            </p>
                                        </div>
                                    </div>
                                </li>
                            `).join('')}
                        </ul>
                    `;
                } else {
                    tachesList.innerHTML = '<p class="text-sm text-gray-500">Aucune t√¢che urgente</p>';
                }

                // Mettre √† jour l'heure de derni√®re mise √† jour
                updateLastRefreshTime();
                
                if (showSuccessNotification) {
                    showNotification('Donn√©es mises √† jour avec succ√®s !', 'success');
                }

            } catch (error) {
                console.error('Erreur lors du chargement des donn√©es:', error);
                showNotification('Erreur lors du chargement des donn√©es', 'error');
            } finally {
                // Restaurer le bouton
                refreshBtn.innerHTML = originalText;
                refreshBtn.disabled = false;
            }
        }

        // Bouton de refresh
        document.getElementById('refreshBtn').addEventListener('click', () => {
            loadDashboardData(true);
        });

        // Auto-refresh toutes les 5 minutes
        setInterval(() => {
            loadDashboardData();
        }, 5 * 60 * 1000);

        // Initialisation
        checkAuth().then(isAuthenticated => {
            if (isAuthenticated) {
                loadDashboardData();
            }
        });
    </script>
</body>
</html>