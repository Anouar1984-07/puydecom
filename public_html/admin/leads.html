<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leads - PuyDeCom Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="icon" href="https://puydecom.fr/images/Logo-Puy-De-Com.jpeg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'puy-orange': '#FF7F50',
                        'puy-red': '#DC2626',
                        'puy-blue': '#1E40AF'
                    },
                    fontFamily: {
                        'inter': ['Inter', 'system-ui', 'sans-serif']
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gradient-to-br from-gray-50 via-white to-gray-100 font-inter min-h-screen">
    <!-- Navigation moderne -->
    <nav class="bg-white/80 backdrop-blur-md shadow-lg border-b border-gray-200/50 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center space-x-3">
                        <img src="https://puydecom.fr/images/Logo-Puy-De-Com.jpeg" alt="PuyDeCom" class="w-10 h-10 rounded-lg shadow-sm">
                        <div>
                            <h1 class="text-xl font-bold text-gray-900">PuyDeCom</h1>
                            <p class="text-xs text-gray-500">Admin Dashboard</p>
                        </div>
                    </div>
                    
                    <!-- Menu desktop moderne -->
                    <div class="hidden md:ml-10 md:flex md:space-x-1">
                        <a href="./dashboard.html" class="text-gray-700 hover:bg-gray-100 px-4 py-2 rounded-lg text-sm font-medium flex items-center space-x-2 transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                            <span>Dashboard</span>
                        </a>
                        <a href="./clients.html" class="text-gray-700 hover:bg-gray-100 px-4 py-2 rounded-lg text-sm font-medium flex items-center space-x-2 transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/>
                            </svg>
                            <span>Clients</span>
                        </a>
                        <a href="./projets.html" class="text-gray-700 hover:bg-gray-100 px-4 py-2 rounded-lg text-sm font-medium flex items-center space-x-2 transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                            </svg>
                            <span>Projets</span>
                        </a>
                        <a href="./leads.html" class="bg-puy-orange text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center space-x-2 shadow-lg">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"/>
                            </svg>
                            <span>Leads</span>
                        </a>
                        <a href="./calendrier.html" class="text-gray-700 hover:bg-gray-100 px-4 py-2 rounded-lg text-sm font-medium flex items-center space-x-2 transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            <span>Calendrier</span>
                        </a>
                        <a href="./analyse360.html" class="text-gray-700 hover:bg-gray-100 px-4 py-2 rounded-lg text-sm font-medium flex items-center space-x-2 transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                            <span>Analyse 360¬∞</span>
                        </a>
                        <a href="https://mail.hostinger.com/" target="_blank" class="text-gray-700 hover:bg-gray-100 px-4 py-2 rounded-lg text-sm font-medium flex items-center space-x-2 transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                            </svg>
                            <span>Emails</span>
                        </a>
                    </div>
                </div>
                
                <!-- Actions utilisateur -->
                <div class="flex items-center space-x-4">
                    <button id="logoutButton" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                        D√©connexion
                    </button>
                    
                    <!-- Menu mobile -->
                    <div class="md:hidden">
                        <button id="mobile-menu-button" type="button" class="bg-gray-100 inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-gray-500 hover:bg-gray-200">
                            <svg class="h-6 w-6" stroke="currentColor" fill="none" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Menu mobile -->
        <div id="mobile-menu" class="md:hidden hidden border-t border-gray-200">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3 bg-white">
                <a href="./dashboard.html" class="text-gray-700 hover:bg-gray-100 block px-3 py-2 rounded-md text-base font-medium">
                    üìä Dashboard
                </a>
                <a href="./clients.html" class="text-gray-700 hover:bg-gray-100 block px-3 py-2 rounded-md text-base font-medium">
                    üë• Clients
                </a>
                <a href="./projets.html" class="text-gray-700 hover:bg-gray-100 block px-3 py-2 rounded-md text-base font-medium">
                    üìÅ Projets
                </a>
                <a href="./leads.html" class="bg-puy-orange text-white block px-3 py-2 rounded-md text-base font-medium">
                    üéØ Leads
                </a>
                <a href="./calendrier.html" class="text-gray-700 hover:bg-gray-100 block px-3 py-2 rounded-md text-base font-medium">
                    üìÖ Calendrier
                </a>
                <a href="./analyse360.html" class="text-gray-700 hover:bg-gray-100 block px-3 py-2 rounded-md text-base font-medium">
                    üìä Analyse 360¬∞
                </a>
                <a href="https://mail.hostinger.com/" target="_blank" class="text-gray-700 hover:bg-gray-100 block px-3 py-2 rounded-md text-base font-medium">
                    üìß Emails
                </a>
            </div>
        </div>
    </nav>

    <!-- Contenu principal -->
    <main class="py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="space-y-8">
                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center space-y-4 sm:space-y-0">
                    <div>
                        <h1 class="text-3xl sm:text-4xl font-bold bg-gradient-to-r from-puy-orange to-puy-red bg-clip-text text-transparent">
                            üéØ Gestion des Leads
                        </h1>
                        <p class="mt-2 text-lg text-gray-600 font-medium">
                            G√©rez vos prospects et transformez-les en clients
                        </p>
                    </div>
                    <div class="flex flex-col sm:flex-row sm:items-center space-y-3 sm:space-y-0 sm:space-x-3">
                        <select id="filterStatut" class="px-3 py-2 border border-gray-300 text-sm rounded-md text-gray-700 bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500 min-h-[44px] w-full sm:w-auto">
                            <option value="">Tous les statuts</option>
                            <option value="nouveau">Nouveau</option>
                            <option value="contacte">Contact√©</option>
                            <option value="qualifie">Qualifi√©</option>
                            <option value="en_negociation">En n√©gociation</option>
                            <option value="converti">Converti</option>
                            <option value="perdu">Perdu</option>
                        </select>
                        <label class="flex items-center space-x-2 text-sm text-gray-700">
                            <input type="checkbox" id="showConverted" class="rounded border-gray-300 text-green-600 focus:ring-green-500">
                            <span>Afficher les convertis</span>
                        </label>
                        <button id="nouveauLeadBtn" class="inline-flex items-center justify-center px-6 py-3 border border-transparent text-sm font-semibold rounded-xl text-white bg-gradient-to-r from-puy-orange to-puy-red hover:from-puy-red hover:to-red-600 min-h-[44px] w-full sm:w-auto shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105">
                            <span class="mr-2">+</span>
                            Nouveau lead
                        </button>
                    </div>
                </div>

                <!-- Statistiques KPI -->
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-xl shadow-sm border border-blue-200 hover:shadow-md transition-shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-3xl font-bold text-blue-700" id="nouveauxLeads">-</div>
                                <div class="text-sm font-semibold text-blue-600 mt-1">Nouveaux</div>
                            </div>
                            <div class="text-blue-500 text-2xl">üÜï</div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 p-6 rounded-xl shadow-sm border border-yellow-200 hover:shadow-md transition-shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-3xl font-bold text-yellow-700" id="leadsContactes">-</div>
                                <div class="text-sm font-semibold text-yellow-600 mt-1">Contact√©s</div>
                            </div>
                            <div class="text-yellow-500 text-2xl">üìû</div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-6 rounded-xl shadow-sm border border-purple-200 hover:shadow-md transition-shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-3xl font-bold text-purple-700" id="leadsQualifies">-</div>
                                <div class="text-sm font-semibold text-purple-600 mt-1">Qualifi√©s</div>
                            </div>
                            <div class="text-purple-500 text-2xl">‚úÖ</div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-green-50 to-green-100 p-6 rounded-xl shadow-sm border border-green-200 hover:shadow-md transition-shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-3xl font-bold text-green-700" id="leadsConvertis">-</div>
                                <div class="text-sm font-semibold text-green-600 mt-1">Convertis</div>
                            </div>
                            <div class="text-green-500 text-2xl">üéâ</div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-red-50 to-red-100 p-6 rounded-xl shadow-sm border border-red-200 hover:shadow-md transition-shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-3xl font-bold text-red-700" id="leadsPerdus">-</div>
                                <div class="text-sm font-semibold text-red-600 mt-1">Perdus</div>
                            </div>
                            <div class="text-red-500 text-2xl">‚ùå</div>
                        </div>
                    </div>
                </div>

                <!-- Liste des leads -->
                <div class="bg-white/90 backdrop-blur shadow-xl overflow-hidden sm:rounded-2xl border border-gray-200">
                    <div id="leadsLoading" class="p-12 text-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-4 border-puy-orange border-t-transparent mx-auto"></div>
                        <p class="mt-4 text-gray-600 font-medium">Chargement des leads...</p>
                    </div>
                    <ul id="leadsList" class="divide-y divide-gray-100 hidden"></ul>
                </div>

            </div>
        </div>
    </main>

    <!-- Modal Nouveau Lead -->
    <div id="leadModal" class="fixed inset-0 bg-black bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 backdrop-blur-sm">
        <div class="relative top-4 sm:top-20 mx-auto p-6 border-0 w-full max-w-lg shadow-2xl rounded-2xl bg-white/95 backdrop-blur-md">
            <div class="mt-3 text-center">
                <div class="text-center mb-6">
                    <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-gradient-to-r from-puy-orange to-puy-red mb-4">
                        <span class="text-2xl text-white">üéØ</span>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900">Nouveau Lead</h3>
                    <p class="text-gray-600 mt-2">Ajoutez un nouveau prospect</p>
                </div>
                <form id="leadForm" class="mt-6 space-y-4 text-left">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Nom complet *</label>
                        <input type="text" id="leadNom" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Email *</label>
                        <input type="email" id="leadEmail" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">T√©l√©phone</label>
                        <input type="tel" id="leadTelephone" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Entreprise</label>
                        <input type="text" id="leadEntreprise" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Secteur d'activit√©</label>
                        <select id="leadSecteur" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">S√©lectionnez un secteur</option>
                            <option value="Agriculture">Agriculture</option>
                            <option value="Alimentation">Alimentation</option>
                            <option value="Automobile">Automobile</option>
                            <option value="Banque/Finance">Banque & Finance</option>
                            <option value="Beaut√©/Cosm√©tique">Beaut√© & Cosm√©tique</option>
                            <option value="BTP/Construction">BTP & Construction</option>
                            <option value="Commerce">Commerce de d√©tail</option>
                            <option value="Conseil">Conseil</option>
                            <option value="E-commerce">E-commerce</option>
                            <option value="√âducation">√âducation & Formation</option>
                            <option value="√ânergie">√ânergie</option>
                            <option value="√âv√©nementiel">√âv√©nementiel</option>
                            <option value="H√¥tellerie">H√¥tellerie</option>
                            <option value="Immobilier">Immobilier</option>
                            <option value="Industrie">Industrie</option>
                            <option value="Informatique">Informatique & Tech</option>
                            <option value="Juridique">Juridique</option>
                            <option value="Logistique">Logistique & Transport</option>
                            <option value="Luxe">Luxe</option>
                            <option value="Marketing">Marketing & Communication</option>
                            <option value="M√©dical">M√©dical & Sant√©</option>
                            <option value="Mode">Mode & Textile</option>
                            <option value="ONG">ONG & Associations</option>
                            <option value="Restaurant">Restauration</option>
                            <option value="Services">Services aux entreprises</option>
                            <option value="Sport">Sport & Loisirs</option>
                            <option value="Startups">Startups</option>
                            <option value="T√©l√©communications">T√©l√©communications</option>
                            <option value="Tourisme">Tourisme</option>
                            <option value="Autre">Autre</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Poste/Fonction</label>
                        <input type="text" id="leadPoste" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Budget estim√© (‚Ç¨)</label>
                        <select id="leadBudget" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">Non sp√©cifi√©</option>
                            <option value="moins_1k">Moins de 1 000‚Ç¨</option>
                            <option value="1k_5k">1 000‚Ç¨ - 5 000‚Ç¨</option>
                            <option value="5k_10k">5 000‚Ç¨ - 10 000‚Ç¨</option>
                            <option value="10k_plus">Plus de 10 000‚Ç¨</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Int√©r√™ts/Services</label>
                        <select id="leadInterets" multiple class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 h-24">
                            <option value="community_management">Community Management</option>
                            <option value="creation_site">Cr√©ation de site web</option>
                            <option value="automatisation">Automatisation</option>
                            <option value="intelligence_artificielle">Intelligence Artificielle</option>
                            <option value="referencement">R√©f√©rencement SEO</option>
                            <option value="publicite">Publicit√© en ligne</option>
                            <option value="formation">Formation</option>
                            <option value="conseil">Conseil strat√©gique</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Maintenez Ctrl/Cmd pour s√©lectionner plusieurs options</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Message/Demande</label>
                        <textarea id="leadMessage" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Source</label>
                        <select id="leadSource" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="site_web">Site web</option>
                            <option value="reseaux_sociaux">R√©seaux sociaux</option>
                            <option value="recommandation">Recommandation</option>
                            <option value="publicite">Publicit√©</option>
                            <option value="evenement">√âv√©nement</option>
                            <option value="autre">Autre</option>
                        </select>
                    </div>
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" id="cancelLead" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-xl font-semibold hover:bg-gray-300 transition-colors">
                            Annuler
                        </button>
                        <button type="submit" class="px-6 py-3 bg-gradient-to-r from-puy-orange to-puy-red text-white rounded-xl font-semibold hover:from-puy-red hover:to-red-600 shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
                            ‚ú® Cr√©er le Lead
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal D√©tails Lead -->
    <div id="leadDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 backdrop-blur-sm">
        <div class="relative top-4 sm:top-20 mx-auto p-6 border-0 w-full max-w-6xl shadow-2xl rounded-2xl bg-white/95 backdrop-blur-md">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold bg-gradient-to-r from-puy-orange to-puy-red bg-clip-text text-transparent">üéØ D√©tails du Lead</h3>
                    <button id="closeLeadDetails" class="text-gray-400 hover:text-gray-600">
                        <span class="sr-only">Fermer</span>
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                
                <div id="leadDetailsContent" class="space-y-6">
                    <!-- Le contenu sera inject√© par JavaScript -->
                </div>

                <div class="flex flex-col sm:flex-row sm:justify-end space-y-2 sm:space-y-0 sm:space-x-3 pt-6 border-t">
                    <button id="convertToClient" class="px-6 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl font-semibold hover:from-green-600 hover:to-green-700 min-h-[44px] shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
                        üéâ Convertir en client
                    </button>
                    <button id="editLead" class="px-6 py-3 bg-gradient-to-r from-puy-orange to-puy-red text-white rounded-xl font-semibold hover:from-puy-red hover:to-red-600 min-h-[44px] shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
                        ‚úèÔ∏è Modifier
                    </button>
                    <button id="deleteLead" class="px-6 py-3 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-xl font-semibold hover:from-red-600 hover:to-red-700 min-h-[44px] shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
                        üóëÔ∏è Supprimer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Edit Lead -->
    <div id="leadEditModal" class="fixed inset-0 bg-black bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 backdrop-blur-sm">
        <div class="relative top-4 sm:top-20 mx-auto p-6 border-0 w-full max-w-4xl shadow-2xl rounded-2xl bg-white/95 backdrop-blur-md">
            <div class="mt-3 text-center">
                <div class="text-center mb-6">
                    <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-gradient-to-r from-puy-orange to-puy-red mb-4">
                        <span class="text-2xl text-white">‚úèÔ∏è</span>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900">Modifier le Lead</h3>
                    <p class="text-gray-600 mt-2">Mettez √† jour les informations du prospect</p>
                </div>
                <form id="leadEditForm" class="mt-6 space-y-4 text-left">
                    <input type="hidden" id="editLeadId">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Nom complet *</label>
                            <input type="text" id="editLeadNom" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Email *</label>
                            <input type="email" id="editLeadEmail" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">T√©l√©phone</label>
                            <input type="tel" id="editLeadTelephone" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Entreprise</label>
                            <input type="text" id="editLeadEntreprise" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Poste/Fonction</label>
                            <input type="text" id="editLeadPoste" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Budget estim√© (‚Ç¨)</label>
                            <select id="editLeadBudget" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">Non sp√©cifi√©</option>
                                <option value="moins_1k">Moins de 1 000‚Ç¨</option>
                                <option value="1k_5k">1 000‚Ç¨ - 5 000‚Ç¨</option>
                                <option value="5k_10k">5 000‚Ç¨ - 10 000‚Ç¨</option>
                                <option value="10k_plus">Plus de 10 000‚Ç¨</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Statut</label>
                            <select id="editLeadStatut" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="nouveau">Nouveau</option>
                                <option value="contacte">Contact√©</option>
                                <option value="qualifie">Qualifi√©</option>
                                <option value="en_negociation">En n√©gociation</option>
                                <option value="converti">Converti</option>
                                <option value="perdu">Perdu</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Source</label>
                            <select id="editLeadSource" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="site_web">Site web</option>
                                <option value="reseaux_sociaux">R√©seaux sociaux</option>
                                <option value="recommandation">Recommandation</option>
                                <option value="publicite">Publicit√©</option>
                                <option value="evenement">√âv√©nement</option>
                                <option value="autre">Autre</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Int√©r√™ts/Services</label>
                        <select id="editLeadInterets" multiple class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 h-24">
                            <option value="community_management">Community Management</option>
                            <option value="creation_site">Cr√©ation de site web</option>
                            <option value="automatisation">Automatisation</option>
                            <option value="intelligence_artificielle">Intelligence Artificielle</option>
                            <option value="referencement">R√©f√©rencement SEO</option>
                            <option value="publicite">Publicit√© en ligne</option>
                            <option value="formation">Formation</option>
                            <option value="conseil">Conseil strat√©gique</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Maintenez Ctrl/Cmd pour s√©lectionner plusieurs options</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Notes internes</label>
                        <textarea id="editLeadNotes" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-3 pt-4">
                        <button type="button" id="cancelEditLead" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-xl font-semibold hover:bg-gray-300 min-h-[44px] transition-colors">
                            Annuler
                        </button>
                        <button type="submit" class="px-6 py-3 bg-gradient-to-r from-puy-orange to-puy-red text-white rounded-xl font-semibold hover:from-puy-red hover:to-red-600 min-h-[44px] shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
                            üíæ Sauvegarder
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Configuration Supabase
        const SUPABASE_URL = 'https://ltqkbtfdjvslqktjtbod.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx0cWtidGZkanZzbHFrdGp0Ym9kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MjE1NzgsImV4cCI6MjA3MjM5NzU3OH0.RnZQZ3QmYrcedLK-IefXCQhTeNFJOUNmU7O0f5HGkLg';
        
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // V√©rifier l'authentification
        async function checkAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                window.location.href = './index.html';
                return false;
            }
            
            return true;
        }

        // D√©connexion
        document.getElementById('logoutButton').addEventListener('click', async () => {
            await supabaseClient.auth.signOut();
            window.location.href = './index.html';
        });

        // Gestion du menu mobile
        document.getElementById('mobile-menu-button').addEventListener('click', () => {
            const mobileMenu = document.getElementById('mobile-menu');
            mobileMenu.classList.toggle('hidden');
        });

        function getStatutColor(statut) {
            switch (statut) {
                case 'nouveau': return 'bg-gradient-to-r from-blue-100 to-blue-200 text-blue-800 border-blue-300';
                case 'contacte': return 'bg-gradient-to-r from-yellow-100 to-yellow-200 text-yellow-800 border-yellow-300';
                case 'qualifie': return 'bg-gradient-to-r from-purple-100 to-purple-200 text-purple-800 border-purple-300';
                case 'en_negociation': return 'bg-gradient-to-r from-indigo-100 to-indigo-200 text-indigo-800 border-indigo-300';
                case 'converti': return 'bg-gradient-to-r from-green-100 to-green-200 text-green-800 border-green-300';
                case 'perdu': return 'bg-gradient-to-r from-red-100 to-red-200 text-red-800 border-red-300';
                default: return 'bg-gradient-to-r from-gray-100 to-gray-200 text-gray-800 border-gray-300';
            }
        }

        function getStatutLabel(statut) {
            switch (statut) {
                case 'nouveau': return 'üÜï Nouveau';
                case 'contacte': return 'üìû Contact√©';
                case 'qualifie': return '‚úÖ Qualifi√©';
                case 'en_negociation': return 'ü§ù En n√©gociation';
                case 'converti': return 'üéâ Converti';
                case 'perdu': return '‚ùå Perdu';
                default: return statut;
            }
        }

        function getSourceIcon(source) {
            switch (source) {
                case 'site_web': return 'üåê';
                case 'reseaux_sociaux': return 'üì±';
                case 'recommandation': return 'üë•';
                case 'publicite': return 'üì∞';
                case 'evenement': return 'üéâ';
                default: return 'üìß';
            }
        }
        
        function getBudgetLabel(budget) {
            switch (budget) {
                case 'moins_1k': return 'Moins de 1 000‚Ç¨';
                case '1k_5k': return '1 000‚Ç¨ - 5 000‚Ç¨';
                case '5k_10k': return '5 000‚Ç¨ - 10 000‚Ç¨';
                case '10k_plus': return 'Plus de 10 000‚Ç¨';
                case 'autre': return 'Autre';
                default: return 'Non sp√©cifi√©';
            }
        }
        
        function getInteretLabel(interet) {
            const labels = {
                'community_management': 'Community Management',
                'creation_site': 'Cr√©ation de site web',
                'automatisation': 'Automatisation',
                'intelligence_artificielle': 'Intelligence Artificielle',
                'referencement': 'R√©f√©rencement SEO',
                'publicite': 'Publicit√© en ligne',
                'formation': 'Formation',
                'conseil': 'Conseil strat√©gique'
            };
            return labels[interet] || interet;
        }

        // Variable pour stocker les leads depuis Supabase
        let leadsData = [];

        // Donn√©es de d√©monstration (sauvegarde)
        const demoLeads = [
            {
                id: '1',
                nom_complet: 'Marie Dubois',
                email: 'marie@hotel-montdore.fr',
                telephone: '04 73 65 12 34',
                entreprise: 'H√¥tel du Mont-Dore',
                poste: 'Directrice Marketing',
                budget_nouveau: '5k_10k',
                interets: 'community_management,referencement',
                message: 'Besoin d\'aide pour la visibilit√© en ligne de notre h√¥tel',
                source: 'reseaux_sociaux',
                statut: 'nouveau',
                date_creation: '2025-01-10T09:15:00Z'
            },
            {
                id: '2',
                nom_complet: 'Pierre Volvic',
                email: 'contact@restaurant-auvergne.fr',
                telephone: '04 73 89 45 67',
                entreprise: 'Restaurant L\'Auvergnat',
                poste: 'Propri√©taire',
                budget_nouveau: '1k_5k',
                interets: 'creation_site,publicite',
                message: 'Cr√©ation d\'un site vitrine avec r√©servation en ligne',
                source: 'recommandation',
                statut: 'contacte',
                date_creation: '2025-01-08T14:30:00Z',
                date_contact: '2025-01-09T10:00:00Z'
            },
            {
                id: '3',
                nom_complet: 'Sophie Clermont',
                email: 'sophie@artisan-volcan.com',
                telephone: '04 73 34 78 90',
                entreprise: 'Artisanat des Volcans',
                poste: 'Artisane',
                budget_nouveau: 'moins_1k',
                interets: 'creation_site,referencement',
                message: 'Site e-commerce pour vendre mes cr√©ations artisanales',
                source: 'site_web',
                statut: 'qualifie',
                date_creation: '2025-01-05T16:45:00Z'
            },
            {
                id: '4',
                nom_complet: 'Jean-Luc Issoire',
                email: 'jl@conseil-auvergne.fr',
                telephone: '04 73 56 23 45',
                entreprise: 'Conseil Auvergne',
                poste: 'Consultant',
                budget_nouveau: '10k_plus',
                interets: 'automatisation,intelligence_artificielle',
                message: 'Automatisation des processus clients et IA',
                source: 'evenement',
                statut: 'en_negociation',
                date_creation: '2025-01-03T11:20:00Z'
            },
            {
                id: '5',
                nom_complet: 'Am√©lie Riom',
                email: 'amelie@boutique-nature.fr',
                telephone: '04 73 78 12 56',
                entreprise: 'Boutique Nature 63',
                poste: 'G√©rante',
                budget_nouveau: '5k_10k',
                interets: 'community_management,publicite,formation',
                message: 'Formation √©quipe + gestion r√©seaux sociaux',
                source: 'publicite',
                statut: 'converti',
                date_creation: '2024-12-28T13:10:00Z'
            },
            {
                id: '6',
                nom_complet: 'Thomas Chamali√®res',
                email: 'thomas@tech-startup.fr',
                telephone: '04 73 45 67 89',
                entreprise: 'TechStart Auvergne',
                poste: 'CEO',
                budget_nouveau: '10k_plus',
                interets: 'conseil,intelligence_artificielle',
                message: 'Conseil strat√©gique pour lev√©e de fonds',
                source: 'recommandation',
                statut: 'perdu',
                date_creation: '2024-12-20T08:30:00Z'
            }
        ];

        // Charger les leads
        async function loadLeads(filtreStatut = '') {
            try {
                // V√©rifier si on doit inclure les leads convertis
                const showConverted = document.getElementById('showConverted')?.checked || false;

                // Charger les leads depuis Supabase
                let query = supabaseClient
                    .from('leads')
                    .select('*');

                // Exclure les convertis par d√©faut sauf si explicitement demand√©
                if (!showConverted && filtreStatut !== 'converti') {
                    query = query.neq('statut', 'converti');
                }

                const { data: leads, error } = await query.order('created_at', { ascending: false });

                if (error) {
                    console.error('Erreur lors du chargement des leads:', error);
                    // En cas d'erreur, utiliser les donn√©es de d√©monstration
                    leadsData = demoLeads.filter(lead => showConverted || lead.statut !== 'converti');
                    console.warn('Utilisation des donn√©es de d√©monstration - V√©rifiez la connexion Supabase');
                } else {
                    leadsData = leads || [];
                }

                // Utiliser les donn√©es charg√©es
                let filteredLeads = leadsData;

                // Appliquer le filtre si n√©cessaire
                if (filtreStatut) {
                    filteredLeads = filteredLeads.filter(lead => lead.statut === filtreStatut);
                }

                // Masquer le loading
                document.getElementById('leadsLoading').classList.add('hidden');
                document.getElementById('leadsList').classList.remove('hidden');

                // Afficher les leads
                const leadsList = document.getElementById('leadsList');
                if (filteredLeads.length > 0) {
                    leadsList.innerHTML = filteredLeads.map(lead => `
                        <li class="hover:bg-gradient-to-r hover:from-gray-50 hover:to-gray-100 transition-all duration-200">
                            <div class="px-6 py-5">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center flex-1">
                                        <div class="flex-shrink-0 h-14 w-14">
                                            <div class="h-14 w-14 rounded-xl bg-gradient-to-br from-puy-orange to-puy-red flex items-center justify-center shadow-md">
                                                <span class="text-white font-bold text-lg">
                                                    ${(lead.nom_complet || lead.nom).split(' ').map(n => n[0]).join('')}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="ml-6 flex-1">
                                            <div class="flex items-center mb-1">
                                                <div class="text-lg font-bold text-gray-900">
                                                    ${lead.nom_complet || lead.nom}
                                                </div>
                                                <span class="ml-3 text-2xl">
                                                    ${getSourceIcon(lead.source)}
                                                </span>
                                            </div>
                                            <div class="flex flex-wrap items-center text-sm text-gray-600 space-x-4">
                                                <span class="flex items-center">
                                                    <span class="mr-1">üìß</span>
                                                    ${lead.email}
                                                </span>
                                                ${lead.telephone ? `
                                                    <span class="flex items-center">
                                                        <span class="mr-1">üì±</span>
                                                        ${lead.telephone}
                                                    </span>
                                                ` : ''}
                                                ${lead.entreprise ? `
                                                    <span class="flex items-center">
                                                        <span class="mr-1">üè¢</span>
                                                        ${lead.entreprise}
                                                    </span>
                                                ` : ''}
                                                ${lead.budget_nouveau ? `
                                                    <span class="flex items-center font-semibold text-green-600">
                                                        <span class="mr-1">üí∞</span>
                                                        ${getBudgetLabel(lead.budget_nouveau)}
                                                    </span>
                                                ` : ''}
                                            </div>
                                            ${lead.message ? `
                                                <div class="text-sm text-gray-500 mt-2 italic max-w-2xl">
                                                    "${lead.message}"
                                                </div>
                                            ` : ''}
                                            <div class="text-xs text-gray-400 mt-2">
                                                üìÖ Cr√©√© le ${new Date(lead.date_creation).toLocaleDateString('fr-FR')} √† ${new Date(lead.date_creation).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-4">
                                        <span class="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-semibold ${getStatutColor(lead.statut)} border">
                                            ${getStatutLabel(lead.statut)}
                                        </span>
                                        <div class="flex space-x-2">
                                            <button onclick="openLeadDetails('${lead.id}')" class="px-4 py-2 bg-gradient-to-r from-puy-orange to-puy-red text-white rounded-lg font-semibold hover:from-puy-red hover:to-red-600 transition-all transform hover:scale-105 shadow-md">
                                                üìä D√©tails
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </li>
                    `).join('');
                } else {
                    leadsList.innerHTML = '<li class="p-12 text-center"><div class="text-gray-400"><div class="text-6xl mb-4">üéØ</div><div class="text-xl font-semibold">Aucun lead trouv√©</div><div class="text-gray-500 mt-2">Commencez par ajouter votre premier prospect</div></div></li>';
                }

                // Calculer les statistiques (sur tous les leads, pas seulement les filtr√©s)
                if (!filtreStatut) {
                    const nouveau = leadsData.filter(l => l.statut === 'nouveau').length;
                    const contacte = leadsData.filter(l => l.statut === 'contacte').length;
                    const qualifie = leadsData.filter(l => l.statut === 'qualifie').length;
                    const en_negociation = leadsData.filter(l => l.statut === 'en_negociation').length;
                    const converti = leadsData.filter(l => l.statut === 'converti').length;
                    const perdu = leadsData.filter(l => l.statut === 'perdu').length;

                    document.getElementById('nouveauxLeads').textContent = nouveau;
                    document.getElementById('leadsContactes').textContent = contacte;
                    document.getElementById('leadsQualifies').textContent = qualifie + en_negociation; // Combiner qualifi√©s + en n√©gociation
                    document.getElementById('leadsConvertis').textContent = converti;
                    document.getElementById('leadsPerdus').textContent = perdu;
                }

            } catch (error) {
                console.error('Erreur lors du chargement des leads:', error);
                document.getElementById('leadsLoading').innerHTML = `
                    <div class="text-red-600 text-center">
                        <div class="text-4xl mb-4">‚ö†Ô∏è</div>
                        <p class="font-semibold">Erreur lors du chargement</p>
                        <p class="text-sm mt-2">${error.message}</p>
                    </div>
                `;
            }
        }

        // Mettre √† jour le statut d'un lead
        window.updateStatut = async function(leadId, nouveauStatut) {
            try {
                const { error } = await supabaseClient
                    .from('leads')
                    .update({ 
                        statut: nouveauStatut,
                        date_contact: nouveauStatut === 'contacte' ? new Date().toISOString() : undefined
                    })
                    .eq('id', leadId);

                if (error) throw error;

                // Recharger les leads
                loadLeads(document.getElementById('filterStatut').value);
                showNotification(`Statut mis √† jour : ${nouveauStatut}`, 'success');

            } catch (error) {
                console.error('Erreur lors de la mise √† jour:', error);
                showNotification('Erreur lors de la mise √† jour: ' + error.message, 'error');
            }
        };

        // Fonction pour convertir un lead en client
        async function convertLeadToClient(leadId) {
            try {
                // R√©cup√©rer les donn√©es du lead
                const lead = leadsData.find(l => l.id === leadId);
                if (!lead) {
                    throw new Error('Lead non trouv√©');
                }

                // Mapper les donn√©es lead vers client
                const clientData = {
                    nom: lead.entreprise || lead.nom_complet || 'Soci√©t√© non renseign√©e',
                    email: lead.email,
                    telephone: lead.telephone,
                    prenom_contact: lead.nom_complet?.split(' ')[0] || '',
                    nom_contact: lead.nom_complet?.split(' ').slice(1).join(' ') || '',
                    fonction: lead.poste,
                    notes: `Converti depuis lead. Message initial: ${lead.message || 'Aucun message'}. Budget estim√©: ${lead.budget_nouveau || 'Non renseign√©'}. Int√©r√™ts: ${lead.interets || 'Non renseign√©'}. Source: ${lead.source || 'Non renseign√©e'}.`,
                    statut: 'actif',
                    source_prospection: lead.source,
                    secteur: lead.secteur || 'Services',
                    site_web: lead.site_web || null,
                    origine_lead_id: leadId,
                    date_conversion_lead: new Date().toISOString()
                };

                // Ins√©rer dans la table clients
                const { data: newClient, error: clientError } = await supabaseClient
                    .from('clients')
                    .insert([clientData])
                    .select();

                if (clientError) throw clientError;

                // Mettre √† jour le statut du lead
                const { error: leadError } = await supabaseClient
                    .from('leads')
                    .update({
                        statut: 'converti',
                        date_conversion: new Date().toISOString(),
                        client_id: newClient[0].id
                    })
                    .eq('id', leadId);

                if (leadError) throw leadError;

                // Fermer le modal et recharger les leads
                document.getElementById('leadDetailsModal').classList.add('hidden');
                loadLeads(document.getElementById('filterStatut').value);

                // Notification et proposition de redirection
                showNotification('üéâ Lead converti en client avec succ√®s !', 'success');

                setTimeout(() => {
                    if (confirm('Voulez-vous voir le nouveau client dans la liste des clients ?')) {
                        window.location.href = `./clients.html?highlight=${newClient[0].id}`;
                    }
                }, 1500);

            } catch (error) {
                console.error('Erreur lors de la conversion:', error);
                showNotification('Erreur lors de la conversion: ' + error.message, 'error');
            }
        }


        // Filtrage
        document.getElementById('filterStatut').addEventListener('change', (e) => {
            loadLeads(e.target.value);
        });

        // Affichage des leads convertis
        document.getElementById('showConverted').addEventListener('change', (e) => {
            loadLeads(document.getElementById('filterStatut').value);
        });

        // Modal nouveau lead
        document.getElementById('nouveauLeadBtn').addEventListener('click', () => {
            document.getElementById('leadModal').classList.remove('hidden');
        });

        document.getElementById('cancelLead').addEventListener('click', () => {
            document.getElementById('leadModal').classList.add('hidden');
            document.getElementById('leadForm').reset();
        });

        // Cr√©er un nouveau lead
        document.getElementById('leadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const interetsSelected = Array.from(document.getElementById('leadInterets').selectedOptions).map(option => option.value);
            
            const newLead = {
                nom: document.getElementById('leadNom').value,
                nom_complet: document.getElementById('leadNom').value,
                email: document.getElementById('leadEmail').value,
                telephone: document.getElementById('leadTelephone').value || null,
                entreprise: document.getElementById('leadEntreprise').value || null,
                secteur: document.getElementById('leadSecteur').value || null,
                poste: document.getElementById('leadPoste').value || null,
                budget_nouveau: document.getElementById('leadBudget').value || null,
                interets: interetsSelected.length > 0 ? interetsSelected.join(',') : null,
                message: document.getElementById('leadMessage').value || null,
                source: document.getElementById('leadSource').value,
                statut: 'nouveau'
            };

            // S'assurer qu'on n'envoie pas d'ID vide (Supabase g√©n√®re automatiquement)
            if (newLead.id !== undefined) {
                delete newLead.id;
            }

            // Debug: afficher les donn√©es envoy√©es
            console.log('Donn√©es lead envoy√©es:', newLead);

            try {
                // Cr√©er le lead dans Supabase
                const { data, error } = await supabaseClient
                    .from('leads')
                    .insert([newLead])
                    .select();

                if (error) {
                    console.error('Erreur lors de la cr√©ation:', error);
                    console.error('Donn√©es envoy√©es:', newLead);
                    if (error.code === '23502') {
                        showNotification('Champ obligatoire manquant', 'error');
                    } else if (error.code === '23505') {
                        showNotification('Un lead avec cet email existe d√©j√†', 'error');
                    } else if (error.code === 'PGRST204') {
                        showNotification('Erreur de colonnes: v√©rifiez les champs du formulaire', 'error');
                    } else {
                        showNotification(`Erreur lors de la cr√©ation: ${error.message || 'Erreur inconnue'}`, 'error');
                    }
                    return;
                }

                // Fermer le modal et recharger
                document.getElementById('leadModal').classList.add('hidden');
                document.getElementById('leadForm').reset();
                loadLeads();
                showNotification('‚ú® Lead cr√©√© avec succ√®s !', 'success');

            } catch (error) {
                console.error('Erreur compl√®te lors de la cr√©ation:', error);
                if (error.status === 400) {
                    showNotification('Erreur de donn√©es: v√©rifiez les champs du formulaire', 'error');
                } else if (error.message) {
                    showNotification(`Erreur: ${error.message}`, 'error');
                } else {
                    showNotification('Erreur lors de la cr√©ation du lead', 'error');
                }
            }
        });

        // Variable globale pour stocker le lead actuel
        let currentLead = null;

        // Fonction pour r√©cup√©rer un lead par ID depuis les donn√©es de d√©mo
        function getLeadById(leadId) {
            return leadsData.find(lead => lead.id === leadId);
        }

        // Fonction pour ouvrir les d√©tails d'un lead
        window.openLeadDetails = async function(leadId) {
            try {
                // Trouver le lead dans les donn√©es de d√©monstration
                const lead = leadsData.find(l => l.id === leadId);
                if (!lead) throw new Error('Lead non trouv√©');

                currentLead = lead;
                
                // Remplir le contenu du modal
                const content = document.getElementById('leadDetailsContent');
                content.innerHTML = `
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="space-y-4">
                            <div>
                                <h4 class="text-sm font-medium text-gray-500 mb-2">Informations personnelles</h4>
                                <div class="bg-gray-50 p-4 rounded-lg space-y-2">
                                    <p class="text-lg font-bold text-gray-900">${lead.nom_complet || lead.nom}</p>
                                    <p class="text-sm text-gray-600">üìß ${lead.email}</p>
                                    ${lead.telephone ? `<p class="text-sm text-gray-600">üì± ${lead.telephone}</p>` : ''}
                                    ${lead.entreprise ? `<p class="text-sm text-gray-600">üè¢ ${lead.entreprise}</p>` : ''}
                                    ${lead.secteur ? `<p class="text-sm text-gray-600">üè≠ ${lead.secteur}</p>` : ''}
                                    ${lead.poste ? `<p class="text-sm text-gray-600">üë§ ${lead.poste}</p>` : ''}
                                </div>
                            </div>
                            
                            <div>
                                <h4 class="text-sm font-medium text-gray-500 mb-2">Statut & Source</h4>
                                <div class="space-y-2">
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm text-gray-600">Statut:</span>
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatutColor(lead.statut)}">
                                            ${lead.statut}
                                        </span>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm text-gray-600">Source:</span>
                                        <span class="text-sm text-gray-900">${lead.source ? lead.source.replace('_', ' ') : 'Non sp√©cifi√©e'}</span>
                                    </div>
                                    ${lead.budget_nouveau ? `
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm text-gray-600">Budget:</span>
                                            <span class="text-sm text-gray-900 font-medium">${getBudgetLabel(lead.budget_nouveau)}</span>
                                        </div>
                                    ` : ''}
                                    ${lead.statut === 'converti' && lead.client_id ? `
                                        <div class="p-3 bg-green-50 border border-green-200 rounded-lg">
                                            <div class="flex items-center justify-between">
                                                <span class="text-sm text-green-700 font-medium">‚úÖ Converti en client</span>
                                                <a href="./clients.html?highlight=${lead.client_id}" class="text-xs bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700 transition-colors">
                                                    Voir le client
                                                </a>
                                            </div>
                                            ${lead.date_conversion ? `<p class="text-xs text-green-600 mt-1">Converti le ${new Date(lead.date_conversion).toLocaleDateString('fr-FR')}</p>` : ''}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <h4 class="text-sm font-medium text-gray-500 mb-2">Dates importantes</h4>
                                <div class="bg-gray-50 p-4 rounded-lg space-y-2">
                                    <div>
                                        <span class="text-sm font-medium text-gray-700">Cr√©√© le:</span>
                                        <p class="text-sm text-gray-900">${new Date(lead.date_creation).toLocaleDateString('fr-FR')} √† ${new Date(lead.date_creation).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}</p>
                                    </div>
                                    ${lead.date_contact ? `
                                        <div>
                                            <span class="text-sm font-medium text-gray-700">Contact√© le:</span>
                                            <p class="text-sm text-gray-900">${new Date(lead.date_contact).toLocaleDateString('fr-FR')}</p>
                                        </div>
                                    ` : ''}
                                    ${lead.date_modification ? `
                                        <div>
                                            <span class="text-sm font-medium text-gray-700">Derni√®re modification:</span>
                                            <p class="text-sm text-gray-900">${new Date(lead.date_modification).toLocaleDateString('fr-FR')}</p>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            <div>
                                <h4 class="text-sm font-medium text-gray-500 mb-2">Actions rapides</h4>
                                <div class="flex flex-col space-y-2">
                                    <a href="mailto:${lead.email}" class="inline-flex items-center justify-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                        üìß Envoyer un email
                                    </a>
                                    ${lead.telephone ? `
                                        <a href="tel:${lead.telephone}" class="inline-flex items-center justify-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                            üì± Appeler
                                        </a>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <h4 class="text-sm font-medium text-gray-500 mb-2">Int√©r√™ts & Services</h4>
                                <div class="flex flex-wrap gap-2">
                                    ${lead.interets ? lead.interets.split(',').map(interet => 
                                        `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">${getInteretLabel(interet.trim())}</span>`
                                    ).join('') : '<span class="text-sm text-gray-500">Aucun int√©r√™t sp√©cifi√©</span>'}
                                </div>
                            </div>
                            
                            ${lead.message ? `
                                <div>
                                    <h4 class="text-sm font-medium text-gray-500 mb-2">Message initial</h4>
                                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                        <p class="text-sm text-blue-900">${lead.message}</p>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    ${lead.notes ? `
                        <div class="pt-4 mt-4 border-t">
                            <h4 class="text-sm font-medium text-gray-500 mb-2">Notes internes</h4>
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                                <p class="text-sm text-yellow-900">${lead.notes}</p>
                            </div>
                        </div>
                    ` : ''}
                `;

                document.getElementById('leadDetailsModal').classList.remove('hidden');

            } catch (error) {
                console.error('Erreur lors du chargement des d√©tails:', error);
                showNotification('Erreur lors du chargement des d√©tails', 'error');
            }
        };

        // Fermer le modal de d√©tails
        document.getElementById('closeLeadDetails').addEventListener('click', () => {
            document.getElementById('leadDetailsModal').classList.add('hidden');
        });

        // Ouvrir le modal d'√©dition
        document.getElementById('editLead').addEventListener('click', () => {
            if (currentLead) {
                // Remplir le formulaire d'√©dition
                document.getElementById('editLeadId').value = currentLead.id;
                document.getElementById('editLeadNom').value = currentLead.nom_complet || currentLead.nom || '';
                document.getElementById('editLeadEmail').value = currentLead.email;
                document.getElementById('editLeadTelephone').value = currentLead.telephone || '';
                document.getElementById('editLeadEntreprise').value = currentLead.entreprise || '';
                document.getElementById('editLeadPoste').value = currentLead.poste || '';
                document.getElementById('editLeadBudget').value = currentLead.budget_nouveau || '';
                document.getElementById('editLeadStatut').value = currentLead.statut;
                document.getElementById('editLeadSource').value = currentLead.source || '';
                document.getElementById('editLeadNotes').value = currentLead.notes || '';
                
                // G√©rer les int√©r√™ts multiples
                const interetsSelect = document.getElementById('editLeadInterets');
                const interets = currentLead.interets ? currentLead.interets.split(',') : [];
                for (let option of interetsSelect.options) {
                    option.selected = interets.includes(option.value);
                }

                // Fermer le modal de d√©tails et ouvrir celui d'√©dition
                document.getElementById('leadDetailsModal').classList.add('hidden');
                document.getElementById('leadEditModal').classList.remove('hidden');
            }
        });

        // Annuler l'√©dition
        document.getElementById('cancelEditLead').addEventListener('click', () => {
            document.getElementById('leadEditModal').classList.add('hidden');
            document.getElementById('leadEditForm').reset();
        });

        // Sauvegarder les modifications
        document.getElementById('leadEditForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const leadId = document.getElementById('editLeadId').value;
            const interetsSelected = Array.from(document.getElementById('editLeadInterets').selectedOptions).map(option => option.value);
            
            const updateData = {
                nom_complet: document.getElementById('editLeadNom').value,
                email: document.getElementById('editLeadEmail').value,
                telephone: document.getElementById('editLeadTelephone').value || null,
                entreprise: document.getElementById('editLeadEntreprise').value || null,
                poste: document.getElementById('editLeadPoste').value || null,
                budget_nouveau: document.getElementById('editLeadBudget').value || null,
                interets: interetsSelected.length > 0 ? interetsSelected.join(',') : null,
                statut: document.getElementById('editLeadStatut').value,
                source: document.getElementById('editLeadSource').value || null,
                notes: document.getElementById('editLeadNotes').value || null,
                date_modification: new Date().toISOString()
            };

            // Si le statut passe √† "contacte", ajouter la date de contact
            if (updateData.statut === 'contacte' && currentLead.statut !== 'contacte') {
                updateData.date_contact = new Date().toISOString();
            }

            try {
                // Mettre √† jour le lead dans Supabase
                const { error } = await supabaseClient
                    .from('leads')
                    .update(updateData)
                    .eq('id', leadId);

                if (error) {
                    console.error('Erreur lors de la mise √† jour:', error);
                    showNotification('Erreur lors de la mise √† jour du lead', 'error');
                    return;
                }

                document.getElementById('leadEditModal').classList.add('hidden');
                document.getElementById('leadEditForm').reset();
                loadLeads(document.getElementById('filterStatut').value);
                showNotification('‚ú® Lead mis √† jour avec succ√®s !', 'success');

            } catch (error) {
                console.error('Erreur lors de la mise √† jour:', error);
                showNotification('Erreur lors de la mise √† jour: ' + error.message, 'error');
            }
        });

        // Convertir le lead en client
        document.getElementById('convertToClient').addEventListener('click', async () => {
            if (currentLead && confirm(`√ätes-vous s√ªr de vouloir convertir le lead "${currentLead.nom_complet}" en client ?`)) {
                await convertLeadToClient(currentLead.id);
            }
        });

        // Supprimer le lead
        document.getElementById('deleteLead').addEventListener('click', async () => {
            if (currentLead && confirm(`√ätes-vous s√ªr de vouloir supprimer le lead "${currentLead.nom_complet}" ? Cette action est irr√©versible.`)) {
                try {
                    // Supprimer le lead dans Supabase
                    const { error } = await supabaseClient
                        .from('leads')
                        .delete()
                        .eq('id', currentLead.id);

                    if (error) {
                        console.error('Erreur lors de la suppression:', error);
                        showNotification('Erreur lors de la suppression du lead', 'error');
                        return;
                    }

                    document.getElementById('leadDetailsModal').classList.add('hidden');
                    loadLeads(document.getElementById('filterStatut').value);
                    showNotification('‚ú® Lead supprim√© avec succ√®s !', 'success');

                } catch (error) {
                    console.error('Erreur lors de la suppression:', error);
                    showNotification('Erreur lors de la suppression: ' + error.message, 'error');
                }
            }
        });

        // Fonction pour afficher les notifications
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `fixed top-6 right-6 px-6 py-4 rounded-xl text-white z-50 shadow-2xl transform transition-all duration-500 ${
                type === 'success' 
                    ? 'bg-gradient-to-r from-green-500 to-green-600 border-2 border-green-400' 
                    : 'bg-gradient-to-r from-red-500 to-red-600 border-2 border-red-400'
            }`;
            notification.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="text-2xl">${type === 'success' ? '‚ú®' : '‚ö†Ô∏è'}</div>
                    <div class="font-semibold">${message}</div>
                </div>
            `;
            document.body.appendChild(notification);
            
            // Animation d'entr√©e
            setTimeout(() => {
                notification.style.transform = 'translateX(0) scale(1)';
            }, 100);
            
            // Animation de sortie et suppression
            setTimeout(() => {
                notification.style.transform = 'translateX(100%) scale(0.8)';
                notification.style.opacity = '0';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        // V√©rifier les param√®tres URL pour configuration automatique
        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const showConverted = urlParams.get('showConverted');
            const filterStatut = urlParams.get('filterStatut');

            if (showConverted === 'true') {
                document.getElementById('showConverted').checked = true;
            }

            if (filterStatut) {
                document.getElementById('filterStatut').value = filterStatut;
            }

            // Nettoyer l'URL
            const newUrl = window.location.pathname;
            window.history.replaceState({}, '', newUrl);
        }

        // Initialisation
        checkAuth().then(isAuthenticated => {
            if (isAuthenticated) {
                checkUrlParams();
                loadLeads(document.getElementById('filterStatut').value);
            }
        });
    </script>
</body>
</html>