<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuration Base de Donn√©es - PuyDeCom Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="icon" href="https://puydecom.fr/images/Logo-Puy-De-Com.jpeg">
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-6xl mx-auto p-6">
        <div class="bg-white rounded-lg shadow-lg p-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-6">üîß Configuration Base de Donn√©es</h1>
            
            <div class="space-y-6">
                <!-- Section V√©rification -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h2 class="text-xl font-semibold text-blue-900 mb-4">üìã V√©rification des Tables</h2>
                    <button id="checkTables" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                        V√©rifier les tables existantes
                    </button>
                    <div id="tablesResult" class="mt-4"></div>
                </div>

                <!-- Section Cr√©ation Vue -->
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <h2 class="text-xl font-semibold text-green-900 mb-4">üîó Vue Calendrier Unifi√©e</h2>
                    <p class="text-sm text-gray-600 mb-4">Cr√©e une vue qui unifie les t√¢ches et √©v√©nements pour le calendrier</p>
                    <button id="createView" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                        Cr√©er la vue calendar_view
                    </button>
                    <div id="viewResult" class="mt-4"></div>
                </div>

                <!-- Section Test -->
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <h2 class="text-xl font-semibold text-yellow-900 mb-4">üß™ Test du Calendrier</h2>
                    <button id="testCalendar" class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700">
                        Tester le chargement des donn√©es
                    </button>
                    <div id="testResult" class="mt-4"></div>
                </div>

                <!-- Section Donn√©es de Test -->
                <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                    <h2 class="text-xl font-semibold text-purple-900 mb-4">üìù Donn√©es de Test</h2>
                    <button id="insertTestData" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">
                        Ajouter des donn√©es de test
                    </button>
                    <div id="testDataResult" class="mt-4"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration Supabase
        const SUPABASE_URL = 'https://ltqkbtfdjvslqktjtbod.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx0cWtidGZkanZzbHFrdGp0Ym9kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MjE1NzgsImV4cCI6MjA3MjM5NzU3OH0.RnZQZ3QmYrcedLK-IefXCQhTeNFJOUNmU7O0f5HGkLg';
        
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        function showResult(elementId, content, isError = false) {
            const element = document.getElementById(elementId);
            element.innerHTML = `
                <div class="mt-4 p-3 rounded-lg ${isError ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                    <pre class="whitespace-pre-wrap font-mono text-sm">${content}</pre>
                </div>
            `;
        }

        // V√©rifier les tables existantes
        document.getElementById('checkTables').addEventListener('click', async () => {
            try {
                // Essayer de lire la structure des tables
                const tables = [];
                
                // Test table tasks
                try {
                    const { data, error } = await supabaseClient.from('tasks').select('*').limit(1);
                    if (!error) {
                        tables.push('‚úÖ tasks - OK');
                        if (data.length > 0) {
                            tables.push(`   Colonnes: ${Object.keys(data[0]).join(', ')}`);
                        }
                    }
                } catch (e) {
                    tables.push('‚ùå tasks - Non trouv√©e ou erreur: ' + e.message);
                }

                // Test table calendar_events
                try {
                    const { data, error } = await supabaseClient.from('calendar_events').select('*').limit(1);
                    if (!error) {
                        tables.push('‚úÖ calendar_events - OK');
                        if (data.length > 0) {
                            tables.push(`   Colonnes: ${Object.keys(data[0]).join(', ')}`);
                        }
                    }
                } catch (e) {
                    tables.push('‚ùå calendar_events - Non trouv√©e ou erreur: ' + e.message);
                }

                // Test vue calendar_view
                try {
                    const { data, error } = await supabaseClient.from('calendar_view').select('*').limit(1);
                    if (!error) {
                        tables.push('‚úÖ calendar_view - OK');
                        if (data.length > 0) {
                            tables.push(`   Colonnes: ${Object.keys(data[0]).join(', ')}`);
                        }
                    }
                } catch (e) {
                    tables.push('‚ùå calendar_view - Non trouv√©e: ' + e.message);
                }

                showResult('tablesResult', tables.join('\n'));
            } catch (error) {
                showResult('tablesResult', 'Erreur: ' + error.message, true);
            }
        });

        // Cr√©er la vue calendar_view
        document.getElementById('createView').addEventListener('click', async () => {
            try {
                const createViewSQL = `
                    CREATE OR REPLACE VIEW calendar_view AS
                    SELECT 
                        'task_' || id::text as id,
                        title,
                        description,
                        due_date as start_time,
                        due_date as end_time,
                        'task' as type,
                        category,
                        priority,
                        status,
                        NULL as location,
                        CASE priority 
                            WHEN 'urgent' THEN '#DC2626'
                            WHEN 'high' THEN '#F59E0B'
                            ELSE '#FF7F50' 
                        END as color,
                        client_name,
                        project_name,
                        estimated_hours,
                        progress,
                        created_at,
                        updated_at
                    FROM tasks
                    WHERE due_date IS NOT NULL
                    
                    UNION ALL
                    
                    SELECT 
                        'event_' || id::text as id,
                        title,
                        description,
                        start_time,
                        end_time,
                        event_type as type,
                        NULL as category,
                        'medium' as priority,
                        'active' as status,
                        location,
                        color,
                        NULL as client_name,
                        NULL as project_name,
                        NULL as estimated_hours,
                        NULL as progress,
                        created_at,
                        updated_at
                    FROM calendar_events;
                `;

                const { data, error } = await supabaseClient.rpc('exec_sql', { sql_query: createViewSQL });
                
                if (error) {
                    // Si la fonction RPC n'existe pas, afficher les instructions
                    showResult('viewResult', 
                        'La vue ne peut pas √™tre cr√©√©e automatiquement.\n\n' +
                        'Veuillez ex√©cuter ce SQL dans l\'√©diteur Supabase :\n\n' + 
                        createViewSQL, 
                        true
                    );
                } else {
                    showResult('viewResult', '‚úÖ Vue calendar_view cr√©√©e avec succ√®s !');
                }
            } catch (error) {
                showResult('viewResult', 'Erreur: ' + error.message, true);
            }
        });

        // Tester le chargement des donn√©es du calendrier
        document.getElementById('testCalendar').addEventListener('click', async () => {
            try {
                const { data, error } = await supabaseClient
                    .from('calendar_view')
                    .select('*')
                    .limit(10);
                
                if (error) throw error;
                
                const result = `‚úÖ Test r√©ussi !\n\nNombre d'√©l√©ments: ${data.length}\n\n` +
                    data.map(item => 
                        `${item.type.toUpperCase()}: ${item.title}\n` +
                        `  Date: ${new Date(item.start_time).toLocaleDateString('fr-FR')}\n` +
                        `  Couleur: ${item.color}`
                    ).join('\n\n');
                
                showResult('testResult', result);
            } catch (error) {
                showResult('testResult', 'Erreur: ' + error.message, true);
            }
        });

        // Ajouter des donn√©es de test
        document.getElementById('insertTestData').addEventListener('click', async () => {
            try {
                const results = [];
                
                // Donn√©es de test pour tasks
                const testTasks = [
                    {
                        title: 'Appel client Restaurant Le Gourmet',
                        description: 'Discuter du nouveau site web',
                        category: 'commercial',
                        priority: 'high',
                        status: 'todo',
                        due_date: new Date(Date.now() + 24*60*60*1000).toISOString(),
                        estimated_hours: 1,
                        client_name: 'Restaurant Le Gourmet'
                    },
                    {
                        title: 'Finaliser logo Boulangerie Martin',
                        description: 'Derniers ajustements sur le logo',
                        category: 'design',
                        priority: 'urgent',
                        status: 'in_progress',
                        due_date: new Date(Date.now() + 2*24*60*60*1000).toISOString(),
                        estimated_hours: 3,
                        client_name: 'Boulangerie Martin',
                        progress: 75
                    }
                ];

                const { data: taskData, error: taskError } = await supabaseClient
                    .from('tasks')
                    .insert(testTasks)
                    .select();
                
                if (taskError) {
                    results.push('‚ùå Erreur t√¢ches: ' + taskError.message);
                } else {
                    results.push(`‚úÖ ${taskData.length} t√¢ches ajout√©es`);
                }

                // Donn√©es de test pour calendar_events
                const testEvents = [
                    {
                        title: 'R√©union √©quipe hebdomadaire',
                        description: 'Point hebdomadaire avec l\'√©quipe',
                        start_time: new Date(Date.now() + 3*24*60*60*1000).toISOString(),
                        end_time: new Date(Date.now() + 3*24*60*60*1000 + 60*60*1000).toISOString(),
                        event_type: 'meeting',
                        location: 'Bureaux PuyDeCom',
                        color: '#059669'
                    },
                    {
                        title: 'Deadline projet TechStart',
                        description: 'Livraison finale du projet',
                        start_time: new Date(Date.now() + 5*24*60*60*1000).toISOString(),
                        end_time: new Date(Date.now() + 5*24*60*60*1000).toISOString(),
                        event_type: 'deadline',
                        color: '#DC2626'
                    }
                ];

                const { data: eventData, error: eventError } = await supabaseClient
                    .from('calendar_events')
                    .insert(testEvents)
                    .select();
                
                if (eventError) {
                    results.push('‚ùå Erreur √©v√©nements: ' + eventError.message);
                } else {
                    results.push(`‚úÖ ${eventData.length} √©v√©nements ajout√©s`);
                }

                showResult('testDataResult', results.join('\n'));
            } catch (error) {
                showResult('testDataResult', 'Erreur: ' + error.message, true);
            }
        });
    </script>
</body>
</html>